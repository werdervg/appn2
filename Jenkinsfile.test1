pipeline {
	environment {
		registry = 'registry.mydomain.com:5000'
		registryCredential = 'admin'
		dockerImage = ''
		GIT_SOURCE = 'https://github.com/werdervg/start.git'
	}
agent any

		
stages {
	stage('Preparation') {
		steps {
			sh 'rm -rf ./*'
		}
	}
	stage('Build') {
		steps {
			sh '"$MVN_HOME/bin/mvn" -Dmaven.test.failure.ignore clean package'
			sh 'cp target/*.jar app.jar'
		}
	}
	stage('Building image') {
		steps{
			script {
				dockerImage = docker.build registry + "/$JOB_NAME" + ":v$BUILD_NUMBER"
			}
		}
	}
	stage('Deploy Image') {
		steps{
			script {
				docker.withRegistry( '' ) {
					dockerImage.push()
				}
			}
		}
	}
	stage('Remove Unused docker image') {
		steps{
			sh "docker rmi $registry/$JOB_NAME:$BUILD_NUMBER"
		}
	}
}
}
